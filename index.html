<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dhaval's Sunny Tasks</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json,{
        'name': 'Dhaval Sunny Tasks',
        'short_name': 'SunnyTasks',
        'start_url': '.',
        'display': 'standalone',
        'background_color': '#e0f2fe',
        'theme_color': '#0ea5e9',
        'icons': [{'src': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMwZWE1ZTkiLz4KPHRleHQgeD0iOTYiIHk9IjExMiIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjYwIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkQ8L3RleHQ+Cjwvc3ZnPg==', 'sizes': '192x192', 'type': 'image/svg+xml'}]
    }">
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r146/three.min.js"></script>

    <style>
        :root {
            /* Sunny / Morning Palette */
            --primary: #0ea5e9;       /* Sky Blue */
            --accent: #f59e0b;        /* Sun Orange */
            --bg-gradient-start: #e0f2fe;
            --bg-gradient-end: #bae6fd;
            
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.8);
            
            --text-main: #334155;     /* Dark Slate */
            --text-muted: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --font-main: 'Quicksand', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: var(--font-main);
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
            color: var(--text-main);
            overflow: hidden; 
            height: 100vh;
        }

        /* --- 3D CANVAS BACKGROUND --- */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* --- MAIN UI CONTAINER --- */
        .app-container {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            height: 100vh;
            overflow-y: auto;
            padding: 20px 20px 110px 20px;
            scrollbar-width: none;
            z-index: 10;
        }
        .app-container::-webkit-scrollbar { display: none; }

        /* --- HEADER --- */
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px 0;
        }
        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #0c4a6e;
            text-shadow: 0 2px 4px rgba(255,255,255,0.5);
        }
        .header p { font-size: 0.9rem; color: #475569; font-weight: 600; }

        /* --- GLASS CARDS (Light Mode) --- */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 2px solid var(--glass-border);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(14, 165, 233, 0.15);
            margin-bottom: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .glass-card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 12px 40px rgba(14, 165, 233, 0.25); 
        }

        /* --- FORM ELEMENTS --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: #475569; font-weight: 700; }
        
        input, select {
            width: 100%;
            padding: 14px;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #e2e8f0;
            border-radius: 14px;
            color: #1e293b;
            font-family: var(--font-main);
            font-weight: 600;
            outline: none;
            transition: all 0.3s;
        }
        input:focus, select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
            background: white;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--primary), #38bdf8);
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
        }
        .btn:active { transform: scale(0.98); }
        .btn-success { background: linear-gradient(135deg, #10b981, #34d399); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #f87171); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); }
        
        /* New AI Button Style */
        .btn-ai {
            background: linear-gradient(135deg, #8b5cf6, #d946ef);
            color: white;
            font-size: 0.8rem;
            padding: 8px 12px;
            border-radius: 10px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            margin-top: 5px;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
            transition: transform 0.2s;
        }
        .btn-ai:hover { transform: scale(1.05); }

        /* --- TABS --- */
        .tab-content { display: none; animation: slideIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- SUB TABS --- */
        .sub-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            padding: 4px;
            margin-bottom: 20px;
        }
        .sub-tab-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 12px;
            font-size: 0.9rem;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        .sub-tab-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        /* --- NUTRITION & DATA RESULT STYLES --- */
        .nutrition-header { text-align: center; margin-bottom: 20px; }
        .nutrition-title { font-size: 1.3rem; font-weight: 800; color: #2563eb; text-transform: uppercase; margin-bottom: 5px; }
        .nutrition-subtitle { font-size: 0.9rem; color: #64748b; font-weight: 600; }
        .chart-label { text-align: center; font-size: 0.9rem; color: #64748b; font-weight: 700; margin-top: 20px; margin-bottom: 10px; }
        
        .macro-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            margin-bottom: 25px;
        }
        .macro-item { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: #475569; font-weight: 600; }
        .color-box { width: 30px; height: 10px; border-radius: 2px; }
        
        .nutrition-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .nutrition-table th { text-align: left; padding: 12px 8px; color: #2563eb; font-weight: 700; border-bottom: 2px solid #e2e8f0; font-size: 0.9rem; white-space: nowrap; }
        .nutrition-table td { padding: 12px 8px; color: #334155; font-weight: 600; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        .nutrition-table tr:last-child td { border-bottom: none; }
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 12px; border: 1px solid rgba(255,255,255,0.5); }

        .list-card-item {
            background: rgba(255, 255, 255, 0.6);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid white;
            font-size: 0.95rem;
            color: #334155;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .list-bullet { color: var(--primary); font-weight: bold; font-size: 1.2em; line-height: 1; }

        .ai-message-box {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid #d8b4fe;
            border-radius: 16px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #4c1d95;
            line-height: 1.5;
            animation: slideIn 0.3s ease;
        }

        /* --- LISTS --- */
        .trade-list { max-height: 400px; overflow-y: auto; margin-top: 15px; }
        .trade-item {
            background: rgba(255,255,255,0.6);
            padding: 15px;
            border-radius: 16px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .delete-btn-sm {
            background: #fee2e2;
            color: #ef4444;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #fecaca;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 700;
        }

        /* --- PROGRESS BARS --- */
        .progress-bar-container {
            background: #e2e8f0;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar-fill { height: 100%; border-radius: 6px; transition: width 0.5s ease; }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid white;
            border-radius: 24px;
            display: flex;
            justify-content: space-around;
            padding: 15px;
            z-index: 100;
            box-shadow: 0 10px 40px rgba(14, 165, 233, 0.2);
        }
        .nav-item {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.6rem;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); }
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--primary);
        }

        /* --- TOAST --- */
        #feedbackContainer { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; max-width: 350px; pointer-events: none; }
        .feedback-box { 
            padding: 14px 24px; 
            border-radius: 16px; 
            color: white; 
            font-weight: 700; 
            text-align: center; 
            margin-bottom: 10px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            animation: fadeInDown 0.3s ease forwards;
        }
        .feedback-box.success { background: rgba(16, 185, 129, 0.95); }
        .feedback-box.error { background: rgba(239, 68, 68, 0.95); }
        
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        /* THEME GRID */
        .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .theme-option { height: 40px; border-radius: 50%; margin: 0 auto; cursor: pointer; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .theme-option.selected { border-color: #334155; transform: scale(1.1); }

    </style>
</head>
<body>

    <!-- 3D Background Canvas -->
    <div id="canvas-container"></div>

    <!-- Main UI -->
    <div class="app-container">
        <div class="header">
            <h1>Good Morning, Dhaval! ‚òÄÔ∏è</h1>
            <p>Let's make today productive.</p>
        </div>

        <!-- STOCKS TAB -->
        <div id="stocks" class="tab-content">
            <div class="glass-card">
                <div id="totalPL" style="text-align: center; margin-bottom: 15px; display: none;">
                    <div style="font-size: 0.9rem; color: #64748b;">Total P/L</div>
                    <div id="totalPLAmount" style="font-size: 2rem; font-weight: 700;">‚Çπ0</div>
                </div>
                <div class="form-group"><label>Stock Ticker</label><input type="text" id="stockName" placeholder="e.g. RELIANCE"></div>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex:1;"><label>Price</label><input type="number" id="buyPrice" placeholder="‚Çπ"></div>
                    <div class="form-group" style="flex:1;"><label>Qty</label><input type="number" id="quantity" placeholder="0"></div>
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn" onclick="addTrade()">Add Investment</button>
                    <button class="btn-ai" onclick="analyzePortfolio()">üß† Analyze Portfolio</button>
                </div>
                <div id="stockAnalysisResult" style="display:none;" class="ai-message-box"></div>
            </div>
            <div id="tradeList"></div>
        </div>

        <!-- NUTRITION TAB -->
        <div id="bmi" class="tab-content active">
            <div class="glass-card">
                <div class="sub-tabs">
                    <div class="sub-tab-btn" onclick="switchNutriMode('general')">üß† AI Coach</div>
                    <div class="sub-tab-btn active" onclick="switchNutriMode('analysis')">üçé Analyze Food</div>
                </div>

                <div id="mode-general" style="display: none;">
                    <div class="form-group"><label>Ask Anything</label><input type="text" id="generalInput" placeholder="Diet plan, IPO list, Advice..."></div>
                    <button class="btn" style="background: linear-gradient(135deg, #8b5cf6, #d946ef);" onclick="askGeneralAI()">Ask Gemini</button>
                </div>

                <div id="mode-analysis">
                    <div class="form-group"><label>What did you eat?</label><input type="text" id="foodInput" placeholder="100 gram paneer"></div>
                    <button class="btn btn-success" onclick="analyzeNutrition()">ANALYZE MACROS</button>
                </div>
                
                <!-- Output Container for ANALYSIS (Table + Chart) -->
                <div id="analysisResultContainer" style="display: none; margin-top: 30px;">
                    <div class="nutrition-header">
                        <div id="resultTitle" class="nutrition-title"></div>
                        <div class="nutrition-subtitle">Nutritional Breakdown</div>
                    </div>

                    <div class="chart-label">Macro Breakdown (grams)</div>
                    <div style="height: 180px; position: relative; width: 100%; display: flex; justify-content: center;">
                        <canvas id="macroPieChart"></canvas>
                    </div>

                    <div class="macro-legend">
                        <div class="macro-item"><div class="color-box" style="background:#34d399"></div>Protein</div>
                        <div class="macro-item"><div class="color-box" style="background:#facc15"></div>Carbs</div>
                        <div class="macro-item"><div class="color-box" style="background:#f87171"></div>Fat</div>
                    </div>

                    <table class="nutrition-table">
                        <thead>
                            <tr>
                                <th>Nutrient</th>
                                <th style="text-align: right;">Value (per serving)</th>
                            </tr>
                        </thead>
                        <tbody id="nutritionTableBody"></tbody>
                    </table>
                </div>
                
                <!-- Output Container for GENERAL AI (Structured Content) -->
                <div id="nutritionResult" style="display: none; margin-top: 20px;"></div>
            </div>
        </div>

        <!-- TODO TAB -->
        <div id="habits" class="tab-content">
            <div class="glass-card">
                <div class="form-group">
                    <label>New Mission</label>
                    <input type="text" id="todoInput" placeholder="e.g., Plan a trip to Goa">
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn" onclick="addTodo()">Add Task</button>
                    <button class="btn-ai" onclick="magicPlan()">‚ú® Magic Breakdown</button>
                </div>
            </div>
            <div id="todoList"></div>
        </div>

        <!-- DAILY LOG TAB -->
        <div id="dailytracker" class="tab-content">
            <div class="glass-card" id="progressSection">
                <!-- JS Injected -->
            </div>
            <div class="glass-card">
                <div class="form-group"><label>Log Meal (AI Auto-Calc)</label><input type="text" id="dtName" placeholder="Paneer Bhurji"></div>
                <button class="btn" onclick="logMealWithAI()">Log to Tracker</button>
            </div>
            <div id="dailyLogList"></div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settings" class="tab-content">
            <div class="glass-card">
                <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: #0c4a6e;">Profile & Stats</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group"><label>Age</label><input type="number" id="userAge"></div>
                    <div class="form-group"><label>Gender</label><select id="userGender"><option value="male">Male</option><option value="female">Female</option></select></div>
                    <div class="form-group"><label>Height (cm)</label><input type="number" id="userHeight"></div>
                    <div class="form-group"><label>Weight (kg)</label><input type="number" id="userWeight"></div>
                </div>
                <div class="form-group"><label>Activity</label>
                    <select id="userActivity">
                        <option value="1.2">Sedentary</option>
                        <option value="1.55">Moderate</option>
                        <option value="1.725">Active</option>
                    </select>
                </div>
                <button class="btn" onclick="saveProfile()">Update Profile</button>
            </div>

            <div class="glass-card">
                <label>Theme Color</label>
                <div class="theme-grid" style="margin-top: 10px;">
                    <div class="theme-option" id="theme-ocean" style="background: #0ea5e9;" onclick="applyTheme('ocean')"></div>
                    <div class="theme-option" id="theme-sunset" style="background: #f97316;" onclick="applyTheme('sunset')"></div>
                    <div class="theme-option" id="theme-forest" style="background: #10b981;" onclick="applyTheme('forest')"></div>
                    <div class="theme-option" id="theme-royal" style="background: #8b5cf6;" onclick="applyTheme('royal')"></div>
                </div>
            </div>

            <div class="glass-card">
                <label>Gemini API Key (For Live Server)</label>
                <input type="text" id="geminiApiKey" placeholder="Paste Key Here if not in Preview">
                <button class="btn btn-success" style="margin-top: 10px;" onclick="saveApiKey()">Save Key</button>
                <button class="btn btn-danger" style="margin-top: 10px;" onclick="clearAllData()">Reset App</button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item" onclick="switchTab('stocks')">üìà</button>
        <button class="nav-item active" onclick="switchTab('bmi')">üß†</button>
        <button class="nav-item" onclick="switchTab('habits')">‚úÖ</button>
        <button class="nav-item" onclick="switchTab('dailytracker')">üìÖ</button>
        <button class="nav-item" onclick="switchTab('settings')">‚öôÔ∏è</button>
    </nav>

    <div id="feedbackContainer"></div>

    <script>
        // --- API KEY LOGIC ---
        const apiKey = ""; 
        
        function getEffectiveKey() {
            const storedKey = localStorage.getItem('geminiApiKey');
            if (storedKey) return storedKey;
            return apiKey; 
        }

        /* =========================================
           THREE.JS: CUTE TEDDY BEAR LOGIC
           ========================================= */
        let scene, camera, renderer;
        let teddy, head, rightArm;
        let mouse; 
        let targetRotation = { x: 0, y: 0 };
        let isWaving = false;

        function initThreeJS() {
            if (typeof THREE === 'undefined') {
                console.error("Three.js not loaded.");
                return;
            }

            mouse = new THREE.Vector2();
            const container = document.getElementById('canvas-container');
            
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0xe0f2fe, 0.015);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;
            camera.position.y = 0.5;

            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);

            const sunLight = new THREE.DirectionalLight(0xfff7e6, 0.8);
            sunLight.position.set(5, 10, 7);
            sunLight.castShadow = true;
            scene.add(sunLight);

            const fillLight = new THREE.PointLight(0xe0f2fe, 0.5);
            fillLight.position.set(-5, 0, 5);
            scene.add(fillLight);

            createTeddy();
            createFloatingDust();

            window.addEventListener('resize', onWindowResize, false);
            document.addEventListener('mousemove', onDocumentMouseMove, false);
            document.addEventListener('touchmove', onDocumentTouchMove, false);
            document.addEventListener('click', onDocumentClick, false);

            animate();
        }

        function createTeddy() {
            teddy = new THREE.Group();
            const furColor = 0xd2b48c; 
            const bellyColor = 0xeaddcf; 
            const furMat = new THREE.MeshStandardMaterial({ color: furColor, roughness: 0.9, metalness: 0.0 });
            const bellyMat = new THREE.MeshStandardMaterial({ color: bellyColor, roughness: 0.9 });
            const noseMat = new THREE.MeshStandardMaterial({ color: 0x3e2723, roughness: 0.4 });
            const eyeMat = new THREE.MeshStandardMaterial({ color: 0x1a1a1a, roughness: 0.1 });

            // Body
            const bodyGeo = new THREE.SphereGeometry(0.85, 32, 32);
            const body = new THREE.Mesh(bodyGeo, furMat);
            body.scale.y = 1.1; 
            teddy.add(body);

            const bellyGeo = new THREE.SphereGeometry(0.6, 32, 32);
            const belly = new THREE.Mesh(bellyGeo, bellyMat);
            belly.position.z = 0.45;
            belly.position.y = -0.1;
            belly.scale.y = 1.1;
            teddy.add(belly);

            // Head
            head = new THREE.Group();
            head.position.y = 1.1;
            const headGeo = new THREE.SphereGeometry(0.65, 32, 32);
            const headMesh = new THREE.Mesh(headGeo, furMat);
            head.add(headMesh);

            const snoutGeo = new THREE.SphereGeometry(0.25, 32, 32);
            const snout = new THREE.Mesh(snoutGeo, bellyMat);
            snout.position.set(0, -0.1, 0.55);
            snout.scale.z = 0.6;
            head.add(snout);

            const noseGeo = new THREE.SphereGeometry(0.1, 16, 16);
            const nose = new THREE.Mesh(noseGeo, noseMat);
            nose.position.set(0, 0, 0.75);
            head.add(nose);

            const eyeGeo = new THREE.SphereGeometry(0.08, 16, 16);
            const eyeL = new THREE.Mesh(eyeGeo, eyeMat);
            eyeL.position.set(-0.25, 0.1, 0.55);
            const eyeR = new THREE.Mesh(eyeGeo, eyeMat);
            eyeR.position.set(0.25, 0.1, 0.55);
            head.add(eyeL);
            head.add(eyeR);

            const earGeo = new THREE.SphereGeometry(0.22, 32, 32);
            const earL = new THREE.Mesh(earGeo, furMat);
            earL.position.set(-0.55, 0.5, 0);
            const earR = new THREE.Mesh(earGeo, furMat);
            earR.position.set(0.55, 0.5, 0);
            head.add(earL);
            head.add(earR);

            teddy.add(head);

            // Limbs
            const limbGeo = new THREE.CapsuleGeometry(0.2, 0.6, 4, 16);
            const leftArm = new THREE.Mesh(limbGeo, furMat);
            leftArm.position.set(-0.9, 0.2, 0);
            leftArm.rotation.z = 0.5;
            leftArm.rotation.x = 0.5;
            teddy.add(leftArm);

            rightArm = new THREE.Group();
            const rArmMesh = new THREE.Mesh(limbGeo, furMat);
            rArmMesh.position.y = -0.3; 
            rightArm.add(rArmMesh);
            rightArm.position.set(0.9, 0.4, 0);
            rightArm.rotation.z = -0.5;
            rightArm.rotation.x = 0.5;
            teddy.add(rightArm);

            const legL = new THREE.Mesh(limbGeo, furMat);
            legL.position.set(-0.4, -1, 0.3);
            legL.rotation.x = -1.5; 
            legL.rotation.z = 0.2;
            teddy.add(legL);

            const legR = new THREE.Mesh(limbGeo, furMat);
            legR.position.set(0.4, -1, 0.3);
            legR.rotation.x = -1.5;
            legR.rotation.z = -0.2;
            teddy.add(legR);

            const padGeo = new THREE.CircleGeometry(0.12, 32);
            const padL = new THREE.Mesh(padGeo, bellyMat);
            padL.position.set(-0.45, -1, 0.6); 
            padL.rotation.x = -0.2;
            teddy.add(padL);

            const padR = new THREE.Mesh(padGeo, bellyMat);
            padR.position.set(0.45, -1, 0.6);
            padR.rotation.x = -0.2;
            teddy.add(padR);

            scene.add(teddy);
        }

        function createFloatingDust() {
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            for (let i = 0; i < 150; i++) {
                vertices.push((Math.random() - 0.5) * 20);
                vertices.push((Math.random() - 0.5) * 20);
                vertices.push((Math.random() - 0.5) * 10 - 2);
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            const material = new THREE.PointsMaterial({ color: 0xffffff, size: 0.1, transparent: true, opacity: 0.8 });
            const particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onDocumentMouseMove(event) {
            if (!mouse) return;
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        function onDocumentTouchMove(event) {
            if (!mouse) return;
            if(event.touches.length > 0) {
                mouse.x = (event.touches[0].clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.touches[0].clientY / window.innerHeight) * 2 + 1;
            }
        }

        function onDocumentClick() {
            if(!isWaving) {
                isWaving = true;
                setTimeout(() => { isWaving = false; }, 1500);
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;
            if(teddy) {
                teddy.position.y = Math.sin(time) * 0.15 - 0.2; 
                teddy.position.x = Math.sin(time * 0.5) * 0.2;
                teddy.rotation.z = Math.sin(time * 0.8) * 0.05;

                if (mouse) {
                    targetRotation.x = mouse.y * 0.3;
                    targetRotation.y = mouse.x * 0.6;
                    head.rotation.x += (targetRotation.x - head.rotation.x) * 0.1;
                    head.rotation.y += (targetRotation.y - head.rotation.y) * 0.1;
                }

                if(rightArm) {
                    if(isWaving) {
                        rightArm.rotation.z = Math.sin(time * 15) * 0.5 + 2.5; 
                    } else {
                        rightArm.rotation.z += (-0.5 - rightArm.rotation.z) * 0.1;
                    }
                }
            }
            renderer.render(scene, camera);
        }

        window.addEventListener('load', initThreeJS);

        /* =========================================
           EXISTING APP LOGIC
           ========================================= */
        let trades = JSON.parse(localStorage.getItem('trades')) || [];
        let todos = JSON.parse(localStorage.getItem('todos')) || []; 
        let dailyMeals = JSON.parse(localStorage.getItem('dailyMeals')) || [];
        let userProfile = JSON.parse(localStorage.getItem('userProfile')) || { age: 22, height: 170, weight: 65, gender: 'male', activity: 1.55 };

        const API_BASE = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        let macroChart = null; 

        async function makeLLMCall(query, prompt, config = {}) {
            const currentKey = getEffectiveKey();
            
            if (!currentKey) {
                showFeedback("üîë Key Missing! Add in Settings.", 'error');
                return "API_KEY_MISSING";
            }

            try {
                const res = await fetch(API_BASE + currentKey, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: query }] }],
                        systemInstruction: { parts: [{ text: prompt }] },
                        generationConfig: config
                    })
                });
                
                if(!res.ok) {
                     if(res.status === 400 || res.status === 403) {
                         showFeedback("üö´ Invalid API Key", 'error');
                         return "API_KEY_INVALID";
                     }
                     throw new Error(res.statusText);
                }

                const data = await res.json();
                let textResponse = data.candidates[0].content.parts[0].text;
                
                if(config.responseMimeType === "application/json") {
                    textResponse = textResponse.replace(/^```json\s*/, "").replace(/\s*```$/, "");
                    try { return JSON.parse(textResponse); } catch (e) { console.error(e); return null; }
                }
                return textResponse;
            } catch(e) { 
                console.error(e); 
                showFeedback("Connection Error", 'error');
                return null; 
            }
        }

        // ... (Goals and Profile functions remain same) ...
        function calculateGoals() {
            let bmr;
            if (userProfile.gender === 'male') {
                bmr = (10 * userProfile.weight) + (6.25 * userProfile.height) - (5 * userProfile.age) + 5;
            } else {
                bmr = (10 * userProfile.weight) + (6.25 * userProfile.height) - (5 * userProfile.age) - 161;
            }
            const tdee = Math.round(bmr * userProfile.activity);
            const proteinG = Math.round(userProfile.weight * 1.8);
            const fatG = Math.round(userProfile.weight * 1);
            const proteinCals = proteinG * 4;
            const fatCals = fatG * 9;
            const remainingCals = tdee - (proteinCals + fatCals);
            const carbsG = remainingCals > 0 ? Math.round(remainingCals / 4) : 0;
            return { calories: tdee, protein: proteinG, carbs: carbsG, fat: fatG };
        }

        function saveProfile() {
            const age = parseInt(document.getElementById('userAge').value);
            const h = parseInt(document.getElementById('userHeight').value);
            const w = parseInt(document.getElementById('userWeight').value);
            const g = document.getElementById('userGender').value;
            const a = parseFloat(document.getElementById('userActivity').value);

            if(!age || !h || !w) { showFeedback('Profile incomplete!', 'error'); return; }

            userProfile = { age, height: h, weight: w, gender: g, activity: a };
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            showFeedback('Profile Updated', 'success');
            updateDailyLog();
        }

        function loadProfileInputs() {
            document.getElementById('userAge').value = userProfile.age || '';
            document.getElementById('userHeight').value = userProfile.height || '';
            document.getElementById('userWeight').value = userProfile.weight || '';
            document.getElementById('userGender').value = userProfile.gender || 'male';
            document.getElementById('userActivity').value = userProfile.activity || 1.55;
        }

        function getTodayDate() { return new Date().toLocaleDateString(); }

        // --- NUTRITION LOGIC ---
        async function logMealWithAI() {
            const mealName = document.getElementById('dtName').value.trim();
            if(!mealName) { showFeedback('Enter meal name', 'error'); return; }
            showFeedback('Thinking...', 'success');
            
            const prompt = `Estimate nutrition for: "${mealName}". Return JSON: { "calories": number, "protein": number, "carbs": number, "fat": number }`;
            const data = await makeLLMCall(mealName, prompt, { responseMimeType: "application/json" });
            
            if(data && typeof data.calories === 'number') {
                dailyMeals.unshift({ ...data, id: Date.now(), name: mealName, date: getTodayDate() });
                localStorage.setItem('dailyMeals', JSON.stringify(dailyMeals));
                document.getElementById('dtName').value = '';
                updateDailyLog();
                showFeedback('Meal Logged!', 'success');
            } else {
                if(data !== "API_KEY_MISSING") showFeedback('AI Analysis Failed', 'error');
            }
        }

        function deleteDailyMeal(id) {
            dailyMeals = dailyMeals.filter(m => m.id !== id);
            localStorage.setItem('dailyMeals', JSON.stringify(dailyMeals));
            updateDailyLog();
        }

        function updateDailyLog() {
            const list = document.getElementById('dailyLogList');
            const progressSection = document.getElementById('progressSection');
            const today = getTodayDate();
            const goals = calculateGoals();
            const todaysMeals = dailyMeals.filter(m => m.date === today);
            
            const totals = todaysMeals.reduce((acc, m) => ({
                cals: acc.cals + (m.calories || 0), p: acc.p + (m.protein || 0), c: acc.c + (m.carbs || 0), f: acc.f + (m.fat || 0)
            }), { cals: 0, p: 0, c: 0, f: 0 });

            const calPercent = Math.min(100, (totals.cals / goals.calories) * 100);

            progressSection.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                    <div><span style="font-size:1.5em; font-weight:700; color:var(--primary);">${totals.cals}</span> <span style="font-size:0.8em; color:#64748b">/ ${goals.calories} kcal</span></div>
                    <div style="font-weight:700; color:${calPercent>=100?'#10b981':'#334155'}">${Math.round(calPercent)}%</div>
                </div>
                <div class="progress-bar-container"><div class="progress-bar-fill" style="width:${calPercent}%; background: linear-gradient(90deg, var(--primary), #38bdf8);"></div></div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px; text-align:center;">
                    <div style="background:rgba(16,185,129,0.1); padding:8px; border-radius:10px;">
                        <div style="font-size:0.7em; color:#10b981;">Protein</div>
                        <div style="font-weight:700;">${totals.p}/${goals.protein}</div>
                    </div>
                    <div style="background:rgba(249,115,22,0.1); padding:8px; border-radius:10px;">
                        <div style="font-size:0.7em; color:#f97316;">Carbs</div>
                        <div style="font-weight:700;">${totals.c}/${goals.carbs}</div>
                    </div>
                    <div style="background:rgba(239,68,68,0.1); padding:8px; border-radius:10px;">
                        <div style="font-size:0.7em; color:#ef4444;">Fats</div>
                        <div style="font-weight:700;">${totals.f}/${goals.fat}</div>
                    </div>
                </div>
            `;

            list.innerHTML = todaysMeals.map(m => `
                <div class="trade-item">
                    <div>
                        <div style="font-weight:600;">${m.name}</div>
                        <div style="font-size:0.8em; color:#64748b;">${m.calories} kcal ‚Ä¢ P:${m.protein} C:${m.carbs} F:${m.fat}</div>
                    </div>
                    <button class="delete-btn-sm" onclick="deleteDailyMeal(${m.id})">Del</button>
                </div>
            `).join('');
        }

        // --- TABS & VISUALS ---
        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            document.querySelector(`.nav-item[onclick="switchTab('${t}')"]`).classList.add('active');
            if(t==='stocks') updateTradeList();
            if(t==='habits') updateTodoList();
            if(t==='dailytracker') updateDailyLog();
            if(t==='settings') loadProfileInputs();
        }

        function showFeedback(msg, type='success') {
            const el = document.getElementById('feedbackContainer');
            const box = document.createElement('div');
            box.className = `feedback-box ${type}`;
            box.innerText = msg;
            el.appendChild(box);
            setTimeout(() => { box.remove(); }, 3000);
        }

        // Stocks
        function addTrade(){ 
            const n=document.getElementById('stockName').value.trim(); 
            const b=parseFloat(document.getElementById('buyPrice').value); 
            const q=parseInt(document.getElementById('quantity').value); 
            if(!n||!b||!q) return showFeedback('Fill details','error');
            trades.unshift({id:Date.now(), name:n, buy:b, qty:q, sell:null}); 
            localStorage.setItem('trades',JSON.stringify(trades)); 
            document.getElementById('stockName').value = '';
            updateTradeList(); showFeedback('Investment Added', 'success');
        }

        function updateTradeList(){
             const l=document.getElementById('tradeList');
             if(!l) return;
             const totalPL = trades.reduce((sum, t) => t.sell ? sum + (t.sell - t.buy) * t.qty : sum, 0);
             document.getElementById('totalPLAmount').textContent = `‚Çπ${totalPL.toLocaleString()}`; 
             document.getElementById('totalPLAmount').style.color = totalPL >= 0 ? '#10b981' : '#ef4444';
             document.getElementById('totalPL').style.display = trades.length > 0 ? 'block' : 'none';

             l.innerHTML = trades.map(t => {
                const isSold = t.sell !== null;
                const pl = isSold ? (t.sell - t.buy) * t.qty : 0;
                return `<div class="trade-item">
                    <div>
                        <div style="font-weight:700; color:var(--primary);">${t.name.toUpperCase()}</div>
                        <div style="color:#64748b; font-size:0.85em;">Avg: ${t.buy} | Qty: ${t.qty}</div>
                        ${isSold ? `<div style="font-weight:600; color:${pl>=0?'#10b981':'#ef4444'}">P/L: ${pl}</div>` : ''}
                    </div>
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        ${!isSold ? `<button class="btn" style="padding:5px 10px; font-size:0.7em;" onclick="sellTrade(${t.id})">Sell</button>` : ''}
                        <button class="delete-btn-sm" onclick="deleteTrade(${t.id})">Del</button>
                    </div>
                </div>`;
             }).join('');
        }

        async function analyzePortfolio() {
            if(trades.length === 0) return showFeedback("Add stocks first!", "error");
            
            showFeedback("ü§ñ Analyzing Portfolio...", "success");
            const resultBox = document.getElementById('stockAnalysisResult');
            resultBox.style.display = 'block';
            resultBox.innerHTML = 'Analyzing...';

            const portfolioStr = trades.map(t => `${t.qty} x ${t.name} @ ${t.buy}`).join(", ");
            const prompt = `Analyze this stock portfolio: ${portfolioStr}. Provide a brief 3-sentence summary on sector diversification and potential risk. Return JSON: { "analysis": "string" }`;
            
            const data = await makeLLMCall("Portfolio Analysis", prompt, { responseMimeType: "application/json" });
            if(data && data.analysis) {
                resultBox.innerHTML = `<strong>üí° AI Insight:</strong><br>${data.analysis}`;
            } else {
                resultBox.innerHTML = "Could not analyze portfolio.";
            }
        }

        function sellTrade(id) {
            const p = prompt("Sell Price?");
            if (p && !isNaN(p)) {
                const t = trades.find(x => x.id === id);
                t.sell = parseFloat(p);
                localStorage.setItem('trades', JSON.stringify(trades));
                updateTradeList();
            }
        }

        function deleteTrade(id) {
            trades = trades.filter(t => t.id !== id);
            localStorage.setItem('trades', JSON.stringify(trades));
            updateTradeList();
        }

        // Nutrition AI Logic (Updated)
        function switchNutriMode(mode) {
            // Toggle Input Forms
            document.getElementById('mode-general').style.display = mode === 'general' ? 'block' : 'none';
            document.getElementById('mode-analysis').style.display = mode === 'analysis' ? 'block' : 'none';
            
            // Toggle Tab Active State
            const buttons = document.querySelectorAll('.sub-tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            // Assuming strict order: 0 is general, 1 is analysis
            if (mode === 'general') buttons[0].classList.add('active');
            else buttons[1].classList.add('active');

            // Toggle Result Containers (The Fix)
            const genResult = document.getElementById('nutritionResult');
            const anaResult = document.getElementById('analysisResultContainer');

            if(mode === 'general') {
                // Show General, Hide Analysis
                anaResult.style.display = 'none';
                // Only show general if it has content
                if(genResult.innerHTML.trim()) genResult.style.display = 'block';
            } else {
                // Show Analysis, Hide General
                genResult.style.display = 'none';
                // Only show analysis if it has content (we check if chart exists or title is set)
                const hasAnalysis = document.getElementById('resultTitle').innerText.trim() !== "";
                if(hasAnalysis) anaResult.style.display = 'block';
            }
        }

        async function askGeneralAI() {
            const query = document.getElementById('generalInput').value;
            if(!query) return showFeedback('Type something...', 'error');
            
            const resultContainer = document.getElementById('nutritionResult');
            resultContainer.style.display = 'block';
            resultContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#64748b; font-weight:600;">ü§ñ Analyzing & Organizing...</div>';
            
            // Context for Dhaval
            const context = "You are an AI assistant for Dhaval (22yo IT professional, Ahmedabad).";
            
            const systemPrompt = `
                ${context}
                Analyze the user's query and format the response as structured JSON to be rendered in a UI.
                
                Rules:
                1. If the data is a list of items with attributes (e.g., IPOs with dates, Stocks with prices, Specs), use "type": "table".
                2. If it's a step-by-step plan or simple list, use "type": "list".
                3. If it's a general explanation, use "type": "text".
                
                JSON Schemas:
                - Table: { "type": "table", "title": "Title", "headers": ["Col1", "Col2"], "rows": [["Row1Col1", "Row1Col2"], ...] }
                - List: { "type": "list", "title": "Title", "items": ["Item 1", "Item 2"] }
                - Text: { "type": "text", "title": "Title", "content": "HTML string" }
                
                Return ONLY the JSON.
            `;

            const data = await makeLLMCall(query, systemPrompt, {responseMimeType: "application/json"});
            
            if (data === "API_KEY_MISSING") return;
            
            if(data) {
                renderGeneralResponse(data);
            } else {
                resultContainer.innerHTML = '<div style="text-align:center; padding:10px; color:#ef4444;">AI Error. Try again.</div>';
            }
        }

        function renderGeneralResponse(data) {
            const container = document.getElementById('nutritionResult');
            let html = '';
            
            // Header
            if(data.title) {
                html += `<div style="text-align:center; margin-bottom:15px;"><h3 style="color:#0ea5e9; font-weight:800; font-size:1.2rem;">${data.title}</h3></div>`;
            }

            if(data.type === 'table') {
                html += '<div class="table-wrapper"><table class="nutrition-table"><thead><tr>';
                data.headers.forEach(h => html += `<th>${h}</th>`);
                html += '</tr></thead><tbody>';
                data.rows.forEach(row => {
                    html += '<tr>';
                    row.forEach(cell => html += `<td>${cell}</td>`);
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
            } else if (data.type === 'list') {
                html += '<div style="display:flex; flex-direction:column; gap:8px;">';
                data.items.forEach(item => {
                    html += `<div class="list-card-item"><span class="list-bullet">‚Ä¢</span><span>${item}</span></div>`;
                });
                html += '</div>';
            } else {
                // Default Text
                html += `<div style="line-height:1.6; font-weight:500; color:#334155; background:rgba(255,255,255,0.5); padding:15px; border-radius:12px;">${data.content}</div>`;
            }
            
            container.innerHTML = html;
        }

        async function analyzeNutrition() {
            const q = document.getElementById('foodInput').value;
            if(!q) return showFeedback('Enter food name!', 'error');
            
            showFeedback('Analyzing Macros...', 'success');
            const data = await makeLLMCall(`Analyze: ${q}`, "Return JSON {food_name: string, data: [{nutrient: string, value: string}]}. Example nutrient strings: 'Protein', 'Carbs', 'Fat', 'Calories'.", {responseMimeType: "application/json"});
             
             if (data === "API_KEY_MISSING") return;

             if(data && data.data) {
                 const p = parseFloat(data.data.find(x=>x.nutrient.toLowerCase().includes('protein'))?.value) || 0;
                 const c = parseFloat(data.data.find(x=>x.nutrient.toLowerCase().includes('carb'))?.value) || 0;
                 const f = parseFloat(data.data.find(x=>x.nutrient.toLowerCase().includes('fat'))?.value) || 0;
                 
                 // Show result container
                 document.getElementById('analysisResultContainer').style.display = 'block';
                 
                 // Update Title
                 document.getElementById('resultTitle').innerText = data.food_name;

                 // Update Chart
                 if(macroChart) macroChart.destroy();
                 macroChart = new Chart(document.getElementById('macroPieChart'), { 
                     type: 'doughnut', 
                     data: { 
                         labels: ['Protein', 'Carbs', 'Fat'], 
                         datasets: [{ 
                             data: [p, c, f], 
                             backgroundColor: ['#34d399', '#facc15', '#f87171'], // Custom colors from image
                             borderWidth: 0,
                             hoverOffset: 4
                         }] 
                     },
                     options: { 
                         cutout: '60%',
                         plugins: { 
                             legend: { display: false }, // Hide default legend
                             tooltip: { enabled: true }
                         },
                         maintainAspectRatio: false
                     }
                 });

                 // Update Table
                 const tableBody = document.getElementById('nutritionTableBody');
                 tableBody.innerHTML = data.data.map(item => `
                    <tr>
                        <td style="color:${item.nutrient.toLowerCase().includes('cal') ? '#2563eb' : ''}">${item.nutrient}</td>
                        <td style="text-align: right;">${item.value}</td>
                    </tr>
                 `).join('');

             } else {
                 showFeedback("Could not analyze.", "error");
             }
        }

        // Todos
        function addTodo(){
            const v=document.getElementById('todoInput').value; if(!v) return;
            todos.unshift({id:Date.now(), task:v, done:false}); localStorage.setItem('todos',JSON.stringify(todos)); 
            document.getElementById('todoInput').value=''; updateTodoList();
        }

        async function magicPlan() {
            const task = document.getElementById('todoInput').value;
            if (!task) return showFeedback("Enter a goal first!", "error");
            
            showFeedback("‚ú® Generating Plan...", "success");
            const prompt = `Break down the goal "${task}" into 3-5 concise, actionable sub-tasks. Return JSON: { "tasks": ["task 1", "task 2"] }`;
            
            const data = await makeLLMCall(task, prompt, { responseMimeType: "application/json" });
            if(data && data.tasks) {
                data.tasks.forEach(t => {
                    todos.unshift({id: Date.now() + Math.random(), task: t, done: false});
                });
                localStorage.setItem('todos', JSON.stringify(todos));
                updateTodoList();
                document.getElementById('todoInput').value = "";
                showFeedback("Plan Created!", "success");
            }
        }

        function updateTodoList(){
            document.getElementById('todoList').innerHTML = todos.map(t=>`
                <div class="trade-item" style="border-left:4px solid ${t.done?'#10b981':'#f59e0b'}">
                    <div onclick="toggleTodo(${t.id})" style="flex:1; cursor:pointer; text-decoration: ${t.done ? 'line-through' : 'none'}; opacity: ${t.done ? '0.6' : '1'}; font-weight: 600;">${t.task}</div>
                    <button class="delete-btn-sm" onclick="deleteTodo(${t.id})">‚úï</button>
                </div>`).join('');
        }
        function toggleTodo(id){ const i=todos.find(x=>x.id==id); if(i){i.done=!i.done; localStorage.setItem('todos',JSON.stringify(todos)); updateTodoList();} }
        function deleteTodo(id){ todos=todos.filter(x=>x.id!==id); localStorage.setItem('todos',JSON.stringify(todos)); updateTodoList(); }

        // Themes
        const themes={
            ocean:{p:'#0ea5e9', a:'#0284c7', bg:'#e0f2fe'},
            sunset:{p:'#f97316', a:'#ea580c', bg:'#ffedd5'},
            forest:{p:'#10b981', a:'#059669', bg:'#d1fae5'},
            royal:{p:'#8b5cf6', a:'#7c3aed', bg:'#ede9fe'}
        };
        function applyTheme(n){
            const t=themes[n]; if(!t)return;
            document.documentElement.style.setProperty('--primary',t.p);
            document.documentElement.style.setProperty('--bg-gradient-start',t.bg);
            document.documentElement.style.setProperty('--bg-gradient-end', '#ffffff');
            localStorage.setItem('theme',n);
            document.querySelectorAll('.theme-option').forEach(e=>e.classList.remove('selected'));
            document.getElementById('theme-'+n).classList.add('selected');
        }
        function saveApiKey(){ 
            const k=document.getElementById('geminiApiKey').value; 
            if(k){
                localStorage.setItem('geminiApiKey',k);
                showFeedback('Key Saved & Ready! üöÄ', 'success');
            }
        }
        function clearAllData(){ if(confirm('Reset?')){localStorage.clear();location.reload();} }

        // Init
        const savedTheme = localStorage.getItem('theme') || 'ocean';
        applyTheme(savedTheme);
        
        updateTradeList(); updateTodoList(); updateDailyLog();
        if(localStorage.getItem('geminiApiKey')) document.getElementById('geminiApiKey').value = "********";

    </script>
</body>
</html>
